# 游戏实验室生成成功率分析与改进方案

## 当前问题分析

### 1. HTML提取失败的主要原因

**问题1: 提取策略不够全面**
- 当前只有5种提取策略
- 无法处理AI输出中的各种格式变体
- 没有处理AI在代码前后添加解释文字的情况

**问题2: 验证逻辑不够严格**
- 只检查基本结构，不验证代码完整性
- 没有检查代码是否真正可执行
- 没有处理部分HTML的情况

**问题3: 没有使用自动重试**
- 虽然创建了`generateWithRetry`，但GameLab没有使用
- 失败后直接报错，没有尝试修复

**问题4: Edge Function提示词不够强制**
- 虽然要求输出HTML，但AI可能不遵守
- 没有强制性的输出格式约束
- 缺少对输出格式的验证和纠正

**问题5: 没有代码后处理**
- 提取的代码可能包含多余内容
- 没有清理和规范化步骤
- 没有修复常见的格式问题

## 改进方案（目标：99.999%成功率）

### 方案1: 增强HTML提取引擎（10+策略）

创建强大的HTML提取器，支持：
1. 标准markdown代码块（```html）
2. 无语言标签代码块（```）
3. 原始HTML（<!DOCTYPE html>）
4. 部分HTML（<html>标签）
5. 去除前后解释文字
6. 处理多段代码块
7. 处理嵌套代码块
8. 处理转义字符
9. 处理不完整的HTML（自动补全）
10. 处理HTML片段（自动包装）

### 方案2: 实现自动重试机制

集成`generateWithRetry`到GameLab：
- 验证失败时自动重试（最多3次）
- 每次重试调整提示词
- 记录失败原因用于改进

### 方案3: 代码后处理和修复

创建代码修复器：
- 自动补全缺失的HTML标签
- 清理多余的解释文字
- 规范化代码格式
- 修复常见的语法错误
- 确保代码完整性

### 方案4: 增强Edge Function提示词

更严格的输出要求：
- 使用JSON Schema约束输出格式
- 强制输出纯HTML，无任何解释
- 添加输出验证步骤
- 使用结构化输出（如果API支持）

### 方案5: 多层验证机制

- 第一层：基本结构验证
- 第二层：代码完整性验证
- 第三层：可执行性验证（尝试解析）
- 第四层：运行时验证（可选，在iframe中测试）

### 方案6: 智能代码修复

- 自动检测并修复常见问题
- 补全缺失的闭合标签
- 修复JavaScript语法错误
- 确保所有函数都已定义

## 实施优先级

**P0（立即实施）：**
1. 增强HTML提取引擎（10+策略）
2. 集成自动重试机制
3. 代码后处理和修复

**P1（快速跟进）：**
4. 增强Edge Function提示词
5. 多层验证机制

**P2（持续优化）：**
6. 智能代码修复
7. 运行时验证
